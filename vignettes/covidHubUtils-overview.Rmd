---
title: "Tools for working with COVID-19 Forecast Hub data: a brief tour of the `covidHubUtils` R package"
author: "Serena Wang, Evan L Ray, Nicholas G Reich"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

### Introduction and background

The [COVID-19 Forecast Hub](https://covid19forecasthub.org/) is a central repository for modeler-contributed short-term forecasts of COVID-19 trends in the US. The US Centers for Disease Control and Prevention (CDC) displays forecasts from the Forecast Hub on its [modeling and forecasting webpages](https://www.cdc.gov/coronavirus/2019-ncov/covid-data/mathematical-modeling.html).

The Forecast Hub has been curating forecast data since April 2020, and has collected over 150 million unique rows of forecast data. These data are stored in our [public GitHub repository](https://github.com/reichlab/covid19-forecast-hub) and in the [Zoltar forecast archive](https://zoltardata.com/). 

The goal of the `covidHubUtils` R package is to create a set of basic utility functions for accessing, visualizing, and scoring forecasts from the COVID-19 Forecast Hub. 


## Installation and set-up

The `covidHubUtils` package relies on a small number of packages, including many from the `tidyverse` and, importantly, [the `zoltr` package](http://reichlab.io/zoltr/) that is used to access the Zoltar API for downloading forecasts. Please install `zoltr` from GitHub, as this development version often has important features not yet on the CRAN version:
```{r message=FALSE, eval=FALSE}
devtools::install_github("reichlab/zoltr")
```

The `covidHubUtils` package currently is only available on GitHub, and it may be installed using the `devtools` package:

```{r message=FALSE, eval=FALSE}
devtools::install_github("reichlab/covidHubUtils")
```


### 
```{r message=FALSE}
library(covidHubUtils)
```

```{r message=FALSE}
# Load forecasts that were submitted in a time window from zoltar
inc_case_targets <- paste(1:4, "wk ahead inc case")
forecasts <- covidHubUtils::load_latest_forecasts(models = "COVIDhub-ensemble",
                      last_forecast_date = Sys.Date(),
                      forecast_date_window_size = 8,
                      locations = "US",
                      types = c("point","quantile"),
                      targets = c(inc_case_targets),
                      source = "zoltar",
                      hub_repo_path = "")


```

```{r message=FALSE}
# Plot point forecasts with prediction intervals and without user-provided truth data
p <- covidHubUtils::plot_forecast (forecast_data = forecasts,
                                   models = "COVIDhub-ensemble",
                                   target_variable = "inc case",
                                   locations = "US",
                                   intervals = c(.5, .8, .95),
                                   horizon = 4,
                                   truth_source = "JHU",
                                   plot = TRUE,
                                   truth_as_of = NULL,
                                   title = "default", 
                                   show_caption = TRUE)

```


```{r message=FALSE}
# Plot point forecasts only and without user-provided truth data
covidHubUtils::plot_forecast (forecast_data = forecasts,
                              models = "COVIDhub-ensemble",
                              target_variable = "inc case",
                              locations = "US",
                              intervals = NULL,
                              horizon = 3,
                              truth_source = "JHU",
                              plot = TRUE,
                              truth_as_of = NULL,
                              title = "default", 
                              show_caption = TRUE)

```

```{r message=FALSE}
# Plot forecasts with user-provided truth data
truth_data <- covidHubUtils::load_truth(truth_source = "NYTimes",
                                       target_variable = "inc case",
                                       locations = 'US')

covidHubUtils::plot_forecast (forecast_data = forecasts,
                              truth_data = truth_data,
                              models = "COVIDhub-ensemble",
                              target_variable = "inc case",
                              locations = "US",
                              intervals = c(.5, .8, .95),
                              horizon = 3,
                              truth_source = "NYTimes",
                              plot = TRUE,
                              # only adding more info in the plot caption now
                              truth_as_of = Sys.Date())


```

```{r message=FALSE}
# Load the latest forecasts that were submitted in a time window from zoltar
inc_case_targets <- paste(1:4, "wk ahead inc case")
forecasts <- covidHubUtils::load_latest_forecasts(
                      models =c("COVIDhub-ensemble","COVIDhub-baseline",
                                       "JHU_CSSE-DECOM","CovidAnalytics-DELPHI",
                                       "LANL-GrowthRate", "MSRA-DeepST"),
                      last_forecast_date = Sys.Date(),
                      forecast_date_window_size = 20,
                      locations = c("US","01","06059"),
                      #locations = "US",
                      types = c("point","quantile"),
                      targets = c(inc_case_targets),
                      source = "zoltar",
                      hub_repo_path = "")


```

```{r message=FALSE}
# facet by location
covidHubUtils::plot_forecast (forecast_data = forecasts,
                              models = c("COVIDhub-ensemble"),
                              target_variable = "inc case",
                              locations = c("US","06059"),
                              intervals = c(.5, 0.8, .95),
                              horizon = 4,
                              truth_source = "JHU",
                              plot = TRUE,
                              facet = ~location,
                              facet_scales = "fixed",
                              title = "default",
                              show_caption = TRUE,
                              # only adding more info in the plot caption now
                              truth_as_of = Sys.Date())

```

```{r message=FALSE}
# facet by model, fill_by_model
covidHubUtils::plot_forecast (forecast_data = forecasts,
                              models = c("COVIDhub-ensemble","COVIDhub-baseline",
                                       "JHU_CSSE-DECOM","CovidAnalytics-DELPHI",
                                       "LANL-GrowthRate", "MSRA-DeepST"),
                              target_variable = "inc case",
                              locations = c("US"),
                              # only .95 prediction interval will be shown 
                              # when more than 5 models are selected
                              intervals = c(.5, .8, .95),
                              horizon = 4,
                              truth_source = "JHU",
                              plot = TRUE,
                              fill_by_model = TRUE,
                              facet = ~model,
                              facet_scales = "fixed",
                              title = "default",
                              show_caption = TRUE,
                              # only adding more info in the plot caption now
                              truth_as_of = Sys.Date())

```

```{r message=FALSE}
# facet by model, fill_by_model
covidHubUtils::plot_forecast (forecast_data = forecasts,
                              models = c("COVIDhub-ensemble","COVIDhub-baseline",
                                       "JHU_CSSE-DECOM","CovidAnalytics-DELPHI",
                                       "LANL-GrowthRate"),
                              target_variable = "inc case",
                              locations = c("US"),
                              intervals = c(.5, .8, .95),
                              horizon = 4,
                              truth_source = "JHU",
                              plot = TRUE,
                              fill_by_model = TRUE,
                              facet = ~model,
                              facet_scales = "fixed",
                              title = "default",
                              show_caption = TRUE,
                              # only adding more info in the plot caption now
                              truth_as_of = Sys.Date())

```

```{r message=FALSE}
# facet by model
covidHubUtils::plot_forecast (forecast_data = forecasts,
                              models = c("COVIDhub-ensemble","COVIDhub-baseline",
                                       "JHU_CSSE-DECOM","CovidAnalytics-DELPHI",
                                       "LANL-GrowthRate"),
                              target_variable = "inc case",
                              locations = c("US"),
                              intervals = c(.5, .8, .95),
                              horizon = 4,
                              truth_source = "JHU",
                              plot = TRUE,
                              fill_by_model = FALSE,
                              facet = ~ model,
                              # to make all predictions interval readable
                              facet_scales = "fixed",
                              title = "default",
                              show_caption = TRUE,
                              # only adding more info in the plot caption now
                              truth_as_of = Sys.Date())

```

```{r message=FALSE}
# Load forecasts that were submitted on selected forecast dates
inc_case_targets <- paste(1:4, "wk ahead inc case")
forecasts <- covidHubUtils::load_forecasts(
                      models = c("COVIDhub-ensemble","COVIDhub-baseline"),
                      forecast_dates = c("2020-11-23", "2020-11-16"),
                      locations = c("US"),
                      types = c("point","quantile"),
                      targets = c(inc_case_targets))
```

```{r message=FALSE}
# facet by model and forecast dates
covidHubUtils::plot_forecast (forecast_data = forecasts,
                              models = c("COVIDhub-ensemble","COVIDhub-baseline"),
                              target_variable = "inc case",
                              locations = c("US"),
                              intervals = c(.5, .8, .95),
                              horizon = 4,
                              truth_source = "JHU",
                              plot = TRUE,
                              fill_by_model = TRUE,
                              facet = model ~ forecast_date,
                              # to make all predictions interval readable
                              facet_scales = "fixed",
                              title = "default",
                              show_caption = TRUE,
                              # only adding more info in the plot caption now
                              truth_as_of = Sys.Date())

```
